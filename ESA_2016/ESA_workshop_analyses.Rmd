---
title: "ESA Workshop"
date: "8 August, 2016"
output:
  pdf_document:
    citation_package: natbib
bibliography: bibliography.bib
---

## Initial Setup
```{r}
# Set working environment
rm(list = ls())
setwd("~/GitHub/ltermetacommunities/ESA_2016/")

# Check for and install required packages
for (package in c('dplyr', 'tidyr', 'vegetarian', 'vegan', 'metacom')) {
  if (!require(package, character.only=T, quietly=T)) {
    install.packages(package)
    library(package, character.only=T)
  }
}
```

## Dataset: NWT Plant Communities
Brief background on dataset?

```{r}
# Read in NWT plant community data and site coordinates 
nwt.xy <- read.csv("NWT_coordinates.csv")
nwt.comm.long <- read.csv("NWT_plantcomp.csv")[,c(2,4,5,6)]
dim(nwt.comm.long)

# Convert to wide format
nwt.comm.wide <- tidyr::spread(nwt.comm.long, 
                               USDA_code, abund,
                               fill = 0)
dim(nwt.comm.wide)
```


## Three analyses for metacommunity time series datasets:

1) Diversity Partitioning [@Jost2007]

2) Variation Partitioning [@Borcard1992; @Legendre2005]

3) Elements of Metacommunity Structure [@Leibold2002; @Presley2010]

### Diversity Paritioning

### Variation Partitioning

### Elements of Metacommunity Structure
```{r}
# First, we'll test on an individual year
nwt.1989 <- filter(nwt.comm.wide, year == 1989)
head(nwt.1989)
nwt.1989 <- nwt.1989[,-which(colSums(nwt.1989) == 0)]
nwt.1989[,which(colSums(nwt.1989) == 0)]
ems.1989 <- Metacommunity(
  decostand(nwt.1989[,-c(1:2)], method = "pa"),
  method = "r1", sims = 100)
IdentifyStructure(ems.1989)
```

Now, we'll take advantage of the time series data
```{r}
# This function accepts wide-format dataset and prints EMS output
fn.ems.loop <- function(comm.wide){
  
  for(year.i in unique(comm.wide$year)){
    comm.year <- filter(comm.wide, year == year.i)[,-c(1:2)] # remove plot & year cols
    comm.year.pa <- decostand(comm.year, method = "pa")
    comm.year.pa <- comm.year.pa[,which(colSums(comm.year.pa) > 0)] # remove empty cols and rows
    comm.year.pa <- comm.year.pa[which(rowSums(comm.year.pa) > 0),]
    ems.year <- Metacommunity(
      comm.year.pa,
      method = "r1", sims = 100)
    #print(ems.year) # print raw values from EMS analysis
    print(IdentifyStructure(ems.year))  # prints the structure of the MC
  }

}
```

Now, call the function:
```{r}
fn.ems.loop(nwt.comm.wide)
```
